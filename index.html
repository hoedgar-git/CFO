<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nonprofit CFO Coach</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a' },
                        brand: { 500: '#3b82f6', 600: '#2563eb' }
                    }
                }
            }
        }
        // Initialize PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .markdown-prose p { margin-bottom: 0.75rem; }
        .markdown-prose ul { list-style-type: disc; margin-left: 1.5rem; margin-bottom: 0.75rem; }
        .markdown-prose li { margin-bottom: 0.25rem; }
        .markdown-prose strong { color: #f8fafc; font-weight: 600; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { MessageSquare, Paperclip, Send, Settings, Pin, Trash2, Plus, FileText, X, ChevronRight, Menu } = lucide;

        // --- CFO PERSONA ---
        const SYSTEM_PROMPT = `You are an expert Nonprofit CFO Coach. You are empathetic, technically accurate, and strategic.
        You specialize in:
        1. GAAP Accounting & FASB ASC 958.
        2. Restricted vs. Unrestricted Net Assets.
        3. Form 990 Compliance.
        4. Budgeting, Cash Flow, and Scenario Planning.
        
        When a user uploads a file/text, analyze it strictly. If they ask for advice, provide actionable steps (journal entries, compliance checks).`;

        const App = () => {
            // --- STATE ---
            const [apiKey, setApiKey] = useState(localStorage.getItem('cfo_api_key') || '');
            const [showSettings, setShowSettings] = useState(!localStorage.getItem('cfo_api_key'));
            const [threads, setThreads] = useState(JSON.parse(localStorage.getItem('cfo_threads') || '[]'));
            const [activeThreadId, setActiveThreadId] = useState(null);
            const [input, setInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [attachedContext, setAttachedContext] = useState(null); // { name: string, content: string }
            const [isSidebarOpen, setSidebarOpen] = useState(true);

            // --- EFFECTS ---
            useEffect(() => {
                localStorage.setItem('cfo_threads', JSON.stringify(threads));
            }, [threads]);

            useEffect(() => {
                lucide.createIcons();
            }, [threads, activeThreadId, showSettings]);

            // --- UTILS ---
            const generateId = () => Math.random().toString(36).substr(2, 9);

            const saveApiKey = (key) => {
                setApiKey(key);
                localStorage.setItem('cfo_api_key', key);
                setShowSettings(false);
            };

            const createNewThread = () => {
                const newThread = {
                    id: generateId(),
                    title: "New Consultation",
                    pinned: false,
                    messages: [{ role: 'system', content: SYSTEM_PROMPT }],
                    lastUpdated: Date.now()
                };
                setThreads([newThread, ...threads]);
                setActiveThreadId(newThread.id);
                if (window.innerWidth < 768) setSidebarOpen(false);
            };

            const activeThread = threads.find(t => t.id === activeThreadId) || null;

            // --- FILE HANDLING ---
            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                if (file.type === "application/pdf") {
                    const reader = new FileReader();
                    reader.onload = async function() {
                        const typedarray = new Uint8Array(this.result);
                        const pdf = await pdfjsLib.getDocument(typedarray).promise;
                        let fullText = "";
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            fullText += textContent.items.map(item => item.str).join(" ");
                        }
                        setAttachedContext({ name: file.name, content: fullText });
                    };
                    reader.readAsArrayBuffer(file);
                } else {
                    // Assume text/csv
                    const reader = new FileReader();
                    reader.onload = (e) => setAttachedContext({ name: file.name, content: e.target.result });
                    reader.readAsText(file);
                }
            };

            // --- CHAT LOGIC ---
            const sendMessage = async () => {
                if (!input.trim() && !attachedContext) return;
                if (!apiKey) { setShowSettings(true); return; }

                const currentThreadId = activeThreadId || (() => {
                    const t = { id: generateId(), title: input.substring(0, 30) + "...", pinned: false, messages: [{role:'system', content:SYSTEM_PROMPT}], lastUpdated: Date.now() };
                    setThreads(prev => [t, ...prev]);
                    setActiveThreadId(t.id);
                    return t.id;
                })();
                
                // Prepare User Message
                let userContent = input;
                if (attachedContext) {
                    userContent += `\n\n[ATTACHED FILE CONTEXT: ${attachedContext.name}]\n${attachedContext.content}\n[END FILE]`;
                }

                const newMsg = { role: 'user', content: userContent, display: input, attachment: attachedContext?.name };
                
                // Optimistic Update
                setThreads(prev => prev.map(t => 
                    t.id === currentThreadId 
                    ? { ...t, messages: [...t.messages, newMsg], lastUpdated: Date.now() } 
                    : t
                ));

                setInput('');
                setAttachedContext(null);
                setIsLoading(true);

                try {
                    // Call OpenAI API
                    const threadMessages = threads.find(t => t.id === currentThreadId)?.messages || [];
                    const messagesToSend = [...threadMessages, newMsg].map(m => ({ role: m.role, content: m.content }));

                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: "gpt-4-turbo",
                            messages: messagesToSend,
                            temperature: 0.7
                        })
                    });

                    const data = await response.json();
                    
                    if (data.error) throw new Error(data.error.message);

                    const assistantMsg = { role: 'assistant', content: data.choices[0].message.content };

                    setThreads(prev => prev.map(t => 
                        t.id === currentThreadId 
                        ? { 
                            ...t, 
                            messages: [...t.messages, newMsg, assistantMsg],
                            title: t.messages.length === 1 ? input.substring(0, 30) : t.title 
                          } 
                        : t
                    ));

                } catch (err) {
                    alert("Error: " + err.message);
                } finally {
                    setIsLoading(false);
                }
            };

            // --- UI HELPERS ---
            const togglePin = (e, id) => {
                e.stopPropagation();
                setThreads(prev => prev.map(t => t.id === id ? { ...t, pinned: !t.pinned } : t));
            };

            const deleteThread = (e, id) => {
                e.stopPropagation();
                if(confirm('Delete this thread?')) {
                    setThreads(prev => prev.filter(t => t.id !== id));
                    if (activeThreadId === id) setActiveThreadId(null);
                }
            };

            // --- RENDER ---
            return (
                <div className="flex h-screen bg-slate-900 text-slate-100 overflow-hidden">
                    
                    {/* SIDEBAR */}
                    <div className={`${isSidebarOpen ? 'w-80' : 'w-0'} transition-all duration-300 bg-slate-950 border-r border-slate-800 flex flex-col h-full absolute md:relative z-20`}>
                        <div className="p-4 border-b border-slate-800 flex justify-between items-center">
                            <h1 className="font-bold text-lg text-white tracking-tight">CFO Coach</h1>
                            <button onClick={() => setShowSettings(true)} className="p-2 hover:bg-slate-800 rounded-lg text-slate-400 hover:text-white transition">
                                <i data-lucide="settings" className="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <div className="p-4">
                            <button onClick={createNewThread} className="w-full bg-brand-600 hover:bg-brand-500 text-white p-3 rounded-lg flex items-center justify-center gap-2 font-medium transition shadow-lg shadow-brand-900/20">
                                <i data-lucide="plus" className="w-5 h-5"></i>
                                New Consultation
                            </button>
                        </div>

                        <div className="flex-1 overflow-y-auto px-2 space-y-1">
                            {/* Pinned Section */}
                            {threads.some(t => t.pinned) && (
                                <div className="mb-4">
                                    <div className="px-3 py-2 text-xs font-semibold text-slate-500 uppercase tracking-wider">Pinned</div>
                                    {threads.filter(t => t.pinned).map(t => (
                                        <ThreadItem key={t.id} t={t} isActive={t.id === activeThreadId} onClick={() => setActiveThreadId(t.id)} onPin={togglePin} onDelete={deleteThread} />
                                    ))}
                                </div>
                            )}
                            
                            {/* Recent Section */}
                            <div className="px-3 py-2 text-xs font-semibold text-slate-500 uppercase tracking-wider">Recent</div>
                            {threads.filter(t => !t.pinned).map(t => (
                                <ThreadItem key={t.id} t={t} isActive={t.id === activeThreadId} onClick={() => setActiveThreadId(t.id)} onPin={togglePin} onDelete={deleteThread} />
                            ))}
                        </div>
                    </div>

                    {/* MAIN CHAT */}
                    <div className="flex-1 flex flex-col h-full relative bg-slate-900">
                        {/* Header */}
                        <div className="h-16 border-b border-slate-800 flex items-center px-6 justify-between bg-slate-900/50 backdrop-blur">
                            <div className="flex items-center gap-4">
                                <button onClick={() => setSidebarOpen(!isSidebarOpen)} className="md:hidden text-slate-400">
                                    <i data-lucide="menu"></i>
                                </button>
                                <span className="font-medium text-slate-200 truncate">
                                    {activeThread ? activeThread.title : "Welcome, CFO"}
                                </span>
                            </div>
                        </div>

                        {/* Messages Area */}
                        <div className="flex-1 overflow-y-auto p-6 space-y-6">
                            {!activeThread ? (
                                <div className="h-full flex flex-col items-center justify-center text-center opacity-40">
                                    <i data-lucide="message-square" className="w-16 h-16 mb-4 text-slate-600"></i>
                                    <h2 className="text-xl font-medium">Ready to discuss finance?</h2>
                                    <p className="mt-2 text-sm text-slate-500 max-w-md">
                                        Ask about Restricted Grants, FASB compliance, or upload a PDF to analyze.
                                    </p>
                                </div>
                            ) : (
                                activeThread.messages.filter(m => m.role !== 'system').map((msg, idx) => (
                                    <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`max-w-3xl rounded-2xl p-5 ${
                                            msg.role === 'user' 
                                            ? 'bg-brand-600 text-white' 
                                            : 'bg-slate-800 text-slate-200 border border-slate-700'
                                        }`}>
                                            {msg.attachment && (
                                                <div className="flex items-center gap-2 mb-3 pb-3 border-b border-white/20">
                                                    <i data-lucide="file-text" className="w-4 h-4"></i>
                                                    <span className="text-xs font-mono">{msg.attachment}</span>
                                                </div>
                                            )}
                                            <div className="markdown-prose whitespace-pre-wrap leading-relaxed">
                                                {msg.display || msg.content}
                                            </div>
                                        </div>
                                    </div>
                                ))
                            )}
                            {isLoading && (
                                <div className="flex justify-start animate-pulse">
                                    <div className="bg-slate-800 rounded-2xl p-4 text-slate-400 text-sm">Thinking...</div>
                                </div>
                            )}
                        </div>

                        {/* Input Area */}
                        <div className="p-4 bg-slate-900 border-t border-slate-800">
                            <div className="max-w-4xl mx-auto relative">
                                {attachedContext && (
                                    <div className="absolute -top-12 left-0 right-0 bg-slate-800 border border-slate-700 rounded-lg p-2 flex items-center justify-between animate-in slide-in-from-bottom-2">
                                        <div className="flex items-center gap-2 text-sm text-brand-400">
                                            <i data-lucide="file-text" className="w-4 h-4"></i>
                                            {attachedContext.name}
                                        </div>
                                        <button onClick={() => setAttachedContext(null)} className="hover:bg-slate-700 p-1 rounded">
                                            <i data-lucide="x" className="w-4 h-4 text-slate-400"></i>
                                        </button>
                                    </div>
                                )}
                                <div className="flex gap-2">
                                    <label className="p-3 text-slate-400 hover:text-brand-400 hover:bg-slate-800 rounded-lg cursor-pointer transition">
                                        <input type="file" onChange={handleFileUpload} className="hidden" accept=".txt,.csv,.json,.pdf,.md" />
                                        <i data-lucide="paperclip" className="w-5 h-5"></i>
                                    </label>
                                    <input 
                                        value={input}
                                        onChange={(e) => setInput(e.target.value)}
                                        onKeyDown={(e) => e.key === 'Enter' && sendMessage()}
                                        placeholder="Ask a question about restricted grants..."
                                        className="flex-1 bg-slate-800 border-none rounded-lg px-4 text-slate-100 focus:ring-2 focus:ring-brand-500 focus:outline-none placeholder-slate-500"
                                    />
                                    <button 
                                        onClick={sendMessage}
                                        disabled={isLoading || (!input && !attachedContext)}
                                        className="p-3 bg-brand-600 hover:bg-brand-500 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-lg transition"
                                    >
                                        <i data-lucide="send" className="w-5 h-5"></i>
                                    </button>
                                </div>
                                <div className="text-center mt-2">
                                    <p className="text-[10px] text-slate-600">Your API Key is stored locally in your browser. No data is sent to our servers.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* SETTINGS MODAL */}
                    {showSettings && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-slate-900 border border-slate-700 p-6 rounded-2xl w-full max-w-md shadow-2xl">
                                <h2 className="text-xl font-bold mb-4">Setup Coach</h2>
                                <p className="text-slate-400 text-sm mb-4">To use this expert CFO coach, you need an OpenAI API Key. It is stored ONLY on your device.</p>
                                <input 
                                    type="password" 
                                    value={apiKey} 
                                    onChange={(e) => setApiKey(e.target.value)}
                                    placeholder="sk-..." 
                                    className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white mb-4 focus:ring-2 focus:ring-brand-500 outline-none"
                                />
                                <div className="flex justify-end gap-2">
                                    <button onClick={() => setShowSettings(false)} className="px-4 py-2 text-slate-400 hover:text-white">Cancel</button>
                                    <button onClick={() => saveApiKey(apiKey)} className="px-4 py-2 bg-brand-600 hover:bg-brand-500 text-white rounded-lg font-medium">Save Key</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ThreadItem = ({ t, isActive, onClick, onPin, onDelete }) => (
            <div 
                onClick={onClick}
                className={`group flex items-center justify-between p-3 rounded-lg cursor-pointer transition mb-1 ${isActive ? 'bg-slate-800 text-white' : 'text-slate-400 hover:bg-slate-900 hover:text-slate-200'}`}
            >
                <div className="truncate text-sm pr-2 flex-1">{t.title}</div>
                <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button onClick={(e) => onPin(e, t.id)} className={`p-1 hover:text-brand-400 ${t.pinned ? 'text-brand-400 opacity-100' : ''}`}>
                        <i data-lucide="pin" className="w-3 h-3"></i>
                    </button>
                    <button onClick={(e) => onDelete(e, t.id)} className="p-1 hover:text-red-400">
                        <i data-lucide="trash-2" className="w-3 h-3"></i>
                    </button>
                </div>
            </div>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
