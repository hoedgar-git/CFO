<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edgar's Site</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        navy: { 800: '#1e3a8a', 900: '#172554' },
                        gold: { 500: '#d97706', 600: '#b45309' }
                    },
                    fontFamily: {
                        sans: ['Arial', 'Helvetica', 'sans-serif'],
                    }
                }
            }
        }
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
        body { background-color: #f3f4f6; color: #1f2937; }
        .markdown-prose p { margin-bottom: 0.75rem; line-height: 1.5; }
        .markdown-prose ul { list-style-type: disc; margin-left: 1.5rem; margin-bottom: 0.75rem; }
        .markdown-prose strong { color: #111827; font-weight: 700; }
        /* Game Animations */
        @keyframes pop { 0% { transform: scale(0.9); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .animate-pop { animation: pop 0.2s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { MessageSquare, Paperclip, Settings, Pin, Trash2, Plus, FileText, X, Briefcase, Layers, Gamepad2, Trophy, RotateCcw, Brain, Calculator, HelpCircle } = lucide;

        // --- PROMPTS ---
        const PROMPTS = {
            coach: `You are an expert Nonprofit CFO Coach. You are formal, precise, and reference FASB ASC 958 frequently. Focus on compliance, restricted net assets, and 990 reporting.`,
            other: `You are a helpful General Assistant for Edgar. You can help with drafting emails, summarizing general documents, and organizing tasks. Keep answers concise.`
        };

        // --- GAME COMPONENTS ---
        
        // 1. TIC-TAC-TOE
        const TicTacToe = () => {
            const [board, setBoard] = useState(Array(9).fill(null));
            const [xIsNext, setXIsNext] = useState(true);
            const winner = calculateWinner(board);

            function calculateWinner(squares) {
                const lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
                for (let i = 0; i < lines.length; i++) {
                    const [a, b, c] = lines[i];
                    if (squares[a] && squares[a] === squares[b] && squares[a] === squares[c]) return squares[a];
                }
                return null;
            }

            const handleClick = (i) => {
                if (winner || board[i]) return;
                const newBoard = [...board];
                newBoard[i] = xIsNext ? 'X' : 'O';
                setBoard(newBoard);
                setXIsNext(!xIsNext);
            };

            return (
                <div className="flex flex-col items-center">
                    <h3 className="text-xl font-bold text-navy-900 mb-4">Tic-Tac-Toe</h3>
                    <div className="grid grid-cols-3 gap-2 bg-navy-900 p-2 rounded-lg">
                        {board.map((cell, i) => (
                            <button key={i} onClick={() => handleClick(i)} className="w-16 h-16 bg-white text-3xl font-bold flex items-center justify-center rounded hover:bg-gray-100">
                                <span className={cell === 'X' ? 'text-navy-800' : 'text-gold-600'}>{cell}</span>
                            </button>
                        ))}
                    </div>
                    <div className="mt-4 text-lg font-semibold">
                        {winner ? <span className="text-green-600">Winner: {winner}</span> : `Next Player: ${xIsNext ? 'X' : 'O'}`}
                    </div>
                    <button onClick={() => setBoard(Array(9).fill(null))} className="mt-4 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm flex items-center gap-2">
                        <RotateCcw className="w-4 h-4"/> Reset
                    </button>
                </div>
            );
        };

        // 2. MEMORY MATCH
        const MemoryMatch = () => {
            const colors = ['bg-red-500', 'bg-blue-500', 'bg-green-500', 'bg-yellow-500', 'bg-purple-500', 'bg-pink-500'];
            const [cards, setCards] = useState([]);
            const [flipped, setFlipped] = useState([]);
            const [solved, setSolved] = useState([]);

            useEffect(() => {
                resetGame();
            }, []);

            const resetGame = () => {
                const deck = [...colors, ...colors]
                    .sort(() => Math.random() - 0.5)
                    .map((color, id) => ({ id, color }));
                setCards(deck);
                setFlipped([]);
                setSolved([]);
            };

            const handleCardClick = (id) => {
                if (flipped.length === 2 || flipped.includes(id) || solved.includes(id)) return;
                
                const newFlipped = [...flipped, id];
                setFlipped(newFlipped);

                if (newFlipped.length === 2) {
                    const [first, second] = newFlipped;
                    if (cards[first].color === cards[second].color) {
                        setSolved([...solved, first, second]);
                        setFlipped([]);
                    } else {
                        setTimeout(() => setFlipped([]), 1000);
                    }
                }
            };

            return (
                <div className="flex flex-col items-center">
                    <h3 className="text-xl font-bold text-navy-900 mb-4">Memory Match</h3>
                    <div className="grid grid-cols-4 gap-2">
                        {cards.map((card, i) => (
                            <div 
                                key={i} 
                                onClick={() => handleCardClick(i)}
                                className={`w-12 h-12 rounded cursor-pointer transition-all duration-300 ${
                                    flipped.includes(i) || solved.includes(i) ? card.color : 'bg-navy-800'
                                }`}
                            ></div>
                        ))}
                    </div>
                    <button onClick={resetGame} className="mt-6 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm flex items-center gap-2">
                        <RotateCcw className="w-4 h-4"/> Reset
                    </button>
                </div>
            );
        };

        // 3. EXECUTIVE DECISION MAKER
        const DecisionMaker = () => {
            const [answer, setAnswer] = useState(null);
            const [loading, setLoading] = useState(false);
            
            const answers = [
                "It is certain.", "It is decidedly so.", "Without a doubt.", 
                "Yes - definitely.", "You may rely on it.", "As I see it, yes.", 
                "Most likely.", "Outlook good.", "Yes.", "Signs point to yes.", 
                "Reply hazy, try again.", "Ask again later.", "Better not tell you now.", 
                "Cannot predict now.", "Concentrate and ask again.", 
                "Don't count on it.", "My reply is no.", "My sources say no.", 
                "Outlook not so good.", "Very doubtful."
            ];

            const shake = () => {
                setLoading(true);
                setAnswer(null);
                setTimeout(() => {
                    setAnswer(answers[Math.floor(Math.random() * answers.length)]);
                    setLoading(false);
                }, 800);
            };

            return (
                <div className="flex flex-col items-center text-center">
                    <h3 className="text-xl font-bold text-navy-900 mb-2">Executive Decision Maker</h3>
                    <p className="text-sm text-gray-500 mb-4">Focus on your question...</p>
                    <div onClick={shake} className="w-32 h-32 bg-black rounded-full flex items-center justify-center cursor-pointer shadow-xl hover:scale-105 transition-transform">
                        <div className="w-16 h-16 bg-navy-900 rounded-full flex items-center justify-center border-2 border-gray-700">
                            <span className="text-white text-2xl font-bold">8</span>
                        </div>
                    </div>
                    <div className="h-16 mt-4 flex items-center justify-center">
                        {loading ? <span className="text-gray-400 animate-pulse">Consulting the board...</span> : 
                         answer && <span className="text-navy-900 font-bold text-lg animate-pop px-4">{answer}</span>}
                    </div>
                </div>
            );
        };

        // 4. QUICK MATH
        const QuickMath = () => {
            const [num1, setNum1] = useState(0);
            const [num2, setNum2] = useState(0);
            const [score, setScore] = useState(0);
            const [input, setInput] = useState('');
            const [feedback, setFeedback] = useState('');

            useEffect(() => { generateProblem(); }, []);

            const generateProblem = () => {
                setNum1(Math.floor(Math.random() * 10) + 1);
                setNum2(Math.floor(Math.random() * 10) + 1);
                setInput('');
            };

            const checkAnswer = (e) => {
                e.preventDefault();
                const val = parseInt(input);
                if (val === num1 * num2) {
                    setScore(score + 1);
                    setFeedback('Correct!');
                    generateProblem();
                } else {
                    setScore(Math.max(0, score - 1));
                    setFeedback('Try again!');
                    setInput('');
                }
                setTimeout(() => setFeedback(''), 1000);
            };

            return (
                <div className="flex flex-col items-center">
                    <h3 className="text-xl font-bold text-navy-900 mb-4">Quick Math (Multiply)</h3>
                    <div className="text-4xl font-bold text-gray-700 mb-4">
                        {num1} x {num2} = ?
                    </div>
                    <form onSubmit={checkAnswer} className="flex gap-2">
                        <input 
                            type="number" 
                            value={input} 
                            onChange={(e) => setInput(e.target.value)} 
                            className="w-20 border-2 border-navy-800 rounded p-2 text-center text-xl font-bold"
                            autoFocus
                        />
                        <button type="submit" className="bg-navy-800 text-white px-4 rounded font-bold">Go</button>
                    </form>
                    <div className="mt-4 flex justify-between w-full px-8 text-sm font-semibold">
                        <span>Score: {score}</span>
                        <span className={feedback === 'Correct!' ? 'text-green-600' : 'text-red-500'}>{feedback}</span>
                    </div>
                </div>
            );
        };


        // --- MAIN APP ---
        const App = () => {
            const [view, setView] = useState('coach'); // 'coach' | 'other' | 'games'
            const [apiKey, setApiKey] = useState(localStorage.getItem('cfo_api_key') || '');
            const [showSettings, setShowSettings] = useState(!localStorage.getItem('cfo_api_key'));
            const [threads, setThreads] = useState(JSON.parse(localStorage.getItem('cfo_threads_v3') || '[]'));
            const [activeThreadId, setActiveThreadId] = useState(null);
            const [input, setInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [attachedContext, setAttachedContext] = useState(null);
            
            // Game State
            const [activeGame, setActiveGame] = useState(null); // 'tic', 'memory', 'decision', 'math'

            useEffect(() => {
                localStorage.setItem('cfo_threads_v3', JSON.stringify(threads));
            }, [threads]);

            useEffect(() => {
                lucide.createIcons();
            }, [threads, activeThreadId, showSettings, view, activeGame]);

            // Filter threads
            const visibleThreads = threads.filter(t => t.type === view || (!t.type && view === 'coach'));

            const generateId = () => Math.random().toString(36).substr(2, 9);

            const saveApiKey = (key) => {
                setApiKey(key);
                localStorage.setItem('cfo_api_key', key);
                setShowSettings(false);
            };

            const createNewThread = () => {
                const newThread = {
                    id: generateId(),
                    type: view,
                    title: "New Consultation",
                    pinned: false,
                    messages: [{ role: 'system', content: PROMPTS[view] }],
                    lastUpdated: Date.now()
                };
                setThreads([newThread, ...threads]);
                setActiveThreadId(newThread.id);
            };

            const activeThread = threads.find(t => t.id === activeThreadId) || null;

            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                if (file.type === "application/pdf") {
                    const reader = new FileReader();
                    reader.onload = async function() {
                        const typedarray = new Uint8Array(this.result);
                        const pdf = await pdfjsLib.getDocument(typedarray).promise;
                        let fullText = "";
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            fullText += textContent.items.map(item => item.str).join(" ");
                        }
                        setAttachedContext({ name: file.name, content: fullText });
                    };
                    reader.readAsArrayBuffer(file);
                } else {
                    const reader = new FileReader();
                    reader.onload = (e) => setAttachedContext({ name: file.name, content: e.target.result });
                    reader.readAsText(file);
                }
            };

            const sendMessage = async () => {
                if (!input.trim() && !attachedContext) return;
                if (!apiKey) { setShowSettings(true); return; }

                let currentThreadId = activeThreadId;
                if (!currentThreadId) {
                    const t = { 
                        id: generateId(), 
                        type: view,
                        title: input.substring(0, 30) + "...", 
                        pinned: false, 
                        messages: [{role:'system', content: PROMPTS[view]}], 
                        lastUpdated: Date.now() 
                    };
                    setThreads(prev => [t, ...prev]);
                    currentThreadId = t.id;
                    setActiveThreadId(t.id);
                }
                
                let userContent = input;
                if (attachedContext) {
                    userContent += `\n\n[ATTACHED FILE CONTEXT: ${attachedContext.name}]\n${attachedContext.content}\n[END FILE]`;
                }

                const newMsg = { role: 'user', content: userContent, display: input, attachment: attachedContext?.name };
                
                setThreads(prev => prev.map(t => 
                    t.id === currentThreadId 
                    ? { ...t, messages: [...t.messages, newMsg], lastUpdated: Date.now() } 
                    : t
                ));

                setInput('');
                setAttachedContext(null);
                setIsLoading(true);

                try {
                    const thread = threads.find(t => t.id === currentThreadId) || { messages: [{role:'system', content: PROMPTS[view]}] };
                    const messagesToSend = [...thread.messages, newMsg].map(m => ({ role: m.role, content: m.content }));

                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                        body: JSON.stringify({ model: "gpt-4-turbo", messages: messagesToSend, temperature: 0.7 })
                    });

                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);

                    const assistantMsg = { role: 'assistant', content: data.choices[0].message.content };

                    setThreads(prev => prev.map(t => 
                        t.id === currentThreadId 
                        ? { ...t, messages: [...t.messages, newMsg, assistantMsg], title: t.messages.length <= 2 ? input.substring(0, 30) : t.title } 
                        : t
                    ));

                } catch (err) {
                    alert("Error: " + err.message);
                } finally {
                    setIsLoading(false);
                }
            };

            const deleteThread = (e, id) => {
                e.stopPropagation();
                if(confirm('Delete this record?')) {
                    setThreads(prev => prev.filter(t => t.id !== id));
                    if (activeThreadId === id) setActiveThreadId(null);
                }
            };

            const togglePin = (e, id) => {
                e.stopPropagation();
                setThreads(prev => prev.map(t => t.id === id ? { ...t, pinned: !t.pinned } : t));
            };

            // --- RENDER HELPERS ---
            
            const renderGames = () => (
                <div className="p-8 h-full overflow-y-auto">
                    {!activeGame ? (
                        <div className="max-w-4xl mx-auto">
                            <h2 className="text-2xl font-bold text-navy-900 mb-6">Executive Break Room</h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {/* Game Cards */}
                                <div onClick={() => setActiveGame('tic')} className="bg-white p-6 rounded-lg shadow border border-gray-200 hover:shadow-lg transition cursor-pointer flex flex-col items-center">
                                    <div className="bg-blue-100 p-4 rounded-full mb-4"><Gamepad2 className="w-8 h-8 text-blue-600"/></div>
                                    <h3 className="font-bold text-lg mb-2">Tic-Tac-Toe</h3>
                                    <p className="text-center text-gray-500 text-sm">Classic strategy for a quick mental break.</p>
                                </div>
                                <div onClick={() => setActiveGame('memory')} className="bg-white p-6 rounded-lg shadow border border-gray-200 hover:shadow-lg transition cursor-pointer flex flex-col items-center">
                                    <div className="bg-green-100 p-4 rounded-full mb-4"><Brain className="w-8 h-8 text-green-600"/></div>
                                    <h3 className="font-bold text-lg mb-2">Memory Match</h3>
                                    <p className="text-center text-gray-500 text-sm">Test your short-term recall.</p>
                                </div>
                                <div onClick={() => setActiveGame('decision')} className="bg-white p-6 rounded-lg shadow border border-gray-200 hover:shadow-lg transition cursor-pointer flex flex-col items-center">
                                    <div className="bg-purple-100 p-4 rounded-full mb-4"><HelpCircle className="w-8 h-8 text-purple-600"/></div>
                                    <h3 className="font-bold text-lg mb-2">Decision Maker</h3>
                                    <p className="text-center text-gray-500 text-sm">Let fate decide your next budget move.</p>
                                </div>
                                <div onClick={() => setActiveGame('math')} className="bg-white p-6 rounded-lg shadow border border-gray-200 hover:shadow-lg transition cursor-pointer flex flex-col items-center">
                                    <div className="bg-orange-100 p-4 rounded-full mb-4"><Calculator className="w-8 h-8 text-orange-600"/></div>
                                    <h3 className="font-bold text-lg mb-2">Quick Math</h3>
                                    <p className="text-center text-gray-500 text-sm">Keep your multiplication skills sharp.</p>
                                </div>
                            </div>
                        </div>
                    ) : (
                        <div className="h-full flex flex-col items-center justify-center">
                            <button onClick={() => setActiveGame(null)} className="mb-8 flex items-center gap-2 text-gray-500 hover:text-navy-900">
                                <RotateCcw className="w-4 h-4"/> Back to Games
                            </button>
                            <div className="bg-white p-8 rounded-xl shadow-xl border border-gray-200 w-full max-w-md">
                                {activeGame === 'tic' && <TicTacToe />}
                                {activeGame === 'memory' && <MemoryMatch />}
                                {activeGame === 'decision' && <DecisionMaker />}
                                {activeGame === 'math' && <QuickMath />}
                            </div>
                        </div>
                    )}
                </div>
            );

            const renderChat = () => (
                <div className="flex flex-col h-full">
                    {/* Top Bar */}
                    <div className="h-16 bg-white border-b border-gray-300 flex items-center justify-between px-6 shadow-sm flex-shrink-0">
                        <h2 className="font-bold text-gray-800 text-lg">
                            {activeThread ? activeThread.title : (view === 'coach' ? "CFO Advisory Console" : "General Workspace")}
                        </h2>
                        <div className="text-xs text-gray-400">
                            {view === 'coach' ? 'Restricted // Financial Data' : 'General // Unclassified'}
                        </div>
                    </div>

                    {/* Messages */}
                    <div className="flex-1 overflow-y-auto p-8 space-y-6">
                        {!activeThread ? (
                            <div className="h-full flex flex-col items-center justify-center opacity-50">
                                <div className="bg-white p-6 rounded-full shadow-sm mb-4">
                                    {view === 'coach' ? <Briefcase className="w-10 h-10 text-navy-800"/> : <Layers className="w-10 h-10 text-gray-600"/>}
                                </div>
                                <h3 className="text-xl font-bold text-gray-700">Select or Start a Thread</h3>
                                <p className="text-gray-500 mt-2">
                                    {view === 'coach' ? 'Access expert nonprofit financial guidance.' : 'Manage general administrative tasks and queries.'}
                                </p>
                            </div>
                        ) : (
                            activeThread.messages.filter(m => m.role !== 'system').map((msg, idx) => (
                                <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`max-w-3xl rounded-lg p-5 border shadow-sm ${
                                        msg.role === 'user' 
                                        ? 'bg-navy-800 text-white border-navy-900' 
                                        : 'bg-white text-gray-800 border-gray-200'
                                    }`}>
                                        {msg.attachment && (
                                            <div className="flex items-center gap-2 mb-3 pb-3 border-b border-white/20">
                                                <FileText className="w-4 h-4"/>
                                                <span className="text-xs font-mono">{msg.attachment}</span>
                                            </div>
                                        )}
                                        <div className="markdown-prose whitespace-pre-wrap">
                                            {msg.display || msg.content}
                                        </div>
                                    </div>
                                </div>
                            ))
                        )}
                        {isLoading && (
                            <div className="flex justify-start">
                                <div className="bg-gray-200 rounded-lg px-4 py-3 text-gray-500 text-sm animate-pulse">Processing...</div>
                            </div>
                        )}
                    </div>

                    {/* Input */}
                    <div className="p-6 bg-white border-t border-gray-300 flex-shrink-0">
                        <div className="max-w-4xl mx-auto">
                            {attachedContext && (
                                <div className="mb-2 bg-blue-50 border border-blue-200 rounded p-2 flex justify-between items-center">
                                    <span className="text-sm text-blue-800 flex items-center gap-2">
                                        <FileText className="w-4 h-4"/> {attachedContext.name}
                                    </span>
                                    <button onClick={() => setAttachedContext(null)} className="text-blue-500 hover:text-blue-700"><X className="w-4 h-4"/></button>
                                </div>
                            )}
                            <div className="flex gap-3">
                                <label className="p-3 bg-gray-100 hover:bg-gray-200 border border-gray-300 rounded text-gray-600 cursor-pointer transition">
                                    <input type="file" onChange={handleFileUpload} className="hidden" />
                                    <Paperclip className="w-5 h-5"/>
                                </label>
                                <input 
                                    value={input}
                                    onChange={(e) => setInput(e.target.value)}
                                    onKeyDown={(e) => e.key === 'Enter' && sendMessage()}
                                    placeholder={`Enter your ${view === 'coach' ? 'financial question' : 'query'}...`}
                                    className="flex-1 border border-gray-300 rounded px-4 py-2 focus:ring-2 focus:ring-navy-800 focus:outline-none"
                                />
                                <button 
                                    onClick={sendMessage}
                                    disabled={isLoading}
                                    className="bg-navy-800 hover:bg-navy-900 text-white px-6 rounded font-semibold transition disabled:opacity-50"
                                >
                                    Send
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );

            // --- MAIN RENDER ---
            return (
                <div className="flex h-screen bg-gray-100 font-sans text-gray-800">
                    
                    {/* LEFT SIDEBAR NAVIGATION */}
                    <div className="w-72 bg-white border-r border-gray-300 flex flex-col shadow-sm z-10">
                        {/* App Header */}
                        <div className="h-16 bg-navy-900 text-white flex items-center px-4 shadow-md">
                            <div className="font-bold text-lg tracking-wide">EDGAR'S SITE</div>
                        </div>

                        {/* View Switcher */}
                        <div className="flex flex-col p-2 gap-1 border-b border-gray-200 bg-gray-50">
                            <div className="flex gap-1">
                                <button 
                                    onClick={() => { setView('coach'); setActiveThreadId(null); setActiveGame(null); }}
                                    className={`flex-1 py-2 px-3 rounded text-sm font-semibold flex items-center justify-center gap-2 transition ${view === 'coach' ? 'bg-white text-navy-900 shadow border border-gray-200' : 'text-gray-500 hover:text-gray-700'}`}
                                >
                                    <Briefcase className="w-4 h-4"/> Coach
                                </button>
                                <button 
                                    onClick={() => { setView('other'); setActiveThreadId(null); setActiveGame(null); }}
                                    className={`flex-1 py-2 px-3 rounded text-sm font-semibold flex items-center justify-center gap-2 transition ${view === 'other' ? 'bg-white text-navy-900 shadow border border-gray-200' : 'text-gray-500 hover:text-gray-700'}`}
                                >
                                    <Layers className="w-4 h-4"/> Other
                                </button>
                            </div>
                            <button 
                                onClick={() => { setView('games'); setActiveThreadId(null); setActiveGame(null); }}
                                className={`w-full py-2 px-3 rounded text-sm font-semibold flex items-center justify-center gap-2 transition ${view === 'games' ? 'bg-white text-gold-600 shadow border border-gray-200' : 'text-gray-500 hover:text-gray-700'}`}
                            >
                                <Gamepad2 className="w-4 h-4"/> Break Room
                            </button>
                        </div>

                        {/* Thread List (Hidden if Games) */}
                        {view !== 'games' ? (
                            <div className="flex-1 overflow-y-auto">
                                <div className="p-3">
                                    <button onClick={createNewThread} className="w-full bg-navy-800 hover:bg-navy-900 text-white py-2 px-4 rounded shadow-sm text-sm font-semibold flex items-center justify-center gap-2 transition">
                                        <Plus className="w-4 h-4"/> New {view === 'coach' ? 'Question' : 'Task'}
                                    </button>
                                </div>
                                
                                <div className="px-3 pb-3 space-y-1">
                                    {visibleThreads.filter(t=>t.pinned).map(t => (
                                        <ThreadItem key={t.id} t={t} isActive={t.id === activeThreadId} onClick={() => setActiveThreadId(t.id)} onPin={togglePin} onDelete={deleteThread} />
                                    ))}
                                    {visibleThreads.length > 0 && <div className="border-t border-gray-200 my-2"></div>}
                                    {visibleThreads.filter(t=>!t.pinned).map(t => (
                                        <ThreadItem key={t.id} t={t} isActive={t.id === activeThreadId} onClick={() => setActiveThreadId(t.id)} onPin={togglePin} onDelete={deleteThread} />
                                    ))}
                                    {visibleThreads.length === 0 && (
                                        <div className="text-center py-8 text-gray-400 text-sm italic">
                                            No {view} records found.
                                        </div>
                                    )}
                                </div>
                            </div>
                        ) : (
                            <div className="flex-1 p-6 text-center text-gray-400 text-sm flex flex-col items-center justify-center">
                                <Trophy className="w-12 h-12 mb-2 text-gray-300"/>
                                <p>Take a break, Edgar.</p>
                            </div>
                        )}

                        {/* Settings Footer */}
                        <div className="p-3 border-t border-gray-200 bg-gray-50">
                            <button onClick={() => setShowSettings(true)} className="flex items-center gap-2 text-sm text-gray-600 hover:text-navy-900">
                                <Settings className="w-4 h-4"/> System Settings
                            </button>
                        </div>
                    </div>

                    {/* MAIN CONTENT AREA */}
                    <div className="flex-1 flex flex-col bg-gray-100">
                        {view === 'games' ? renderGames() : renderChat()}
                    </div>

                    {/* SETTINGS MODAL */}
                    {showSettings && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
                            <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-md border border-gray-200">
                                <h3 className="text-lg font-bold text-gray-900 mb-4">Configuration</h3>
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">OpenAI API Key</label>
                                    <input 
                                        type="password" 
                                        value={apiKey} 
                                        onChange={(e) => setApiKey(e.target.value)}
                                        className="w-full border border-gray-300 rounded p-2 text-sm focus:ring-2 focus:ring-navy-800 outline-none"
                                        placeholder="sk-..."
                                    />
                                    <p className="text-xs text-gray-500 mt-1">Key is stored locally in your browser.</p>
                                </div>
                                <div className="flex justify-end gap-2">
                                    <button onClick={() => setShowSettings(false)} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                                    <button onClick={() => saveApiKey(apiKey)} className="px-4 py-2 bg-navy-800 text-white rounded hover:bg-navy-900">Save</button>
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        const ThreadItem = ({ t, isActive, onClick, onPin, onDelete }) => (
            <div 
                onClick={onClick}
                className={`group flex items-center justify-between p-2 rounded cursor-pointer border mb-1 transition ${
                    isActive 
                    ? 'bg-blue-50 border-blue-200 text-navy-900' 
                    : 'bg-white border-transparent hover:bg-gray-100 text-gray-600'
                }`}
            >
                <div className="truncate text-sm pr-2 flex-1 font-medium">{t.title}</div>
                <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button onClick={(e) => onPin(e, t.id)} className={`p-1 hover:text-navy-800 ${t.pinned ? 'text-navy-800 opacity-100' : ''}`}>
                        <Pin className="w-3 h-3"/>
                    </button>
                    <button onClick={(e) => onDelete(e, t.id)} className="p-1 hover:text-red-600">
                        <Trash2 className="w-3 h-3"/>
                    </button>
                </div>
            </div>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
